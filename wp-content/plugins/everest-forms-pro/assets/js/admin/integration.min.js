!function(l){var r,s={settings:{form:l("#everest-forms-builder-form"),spinner:'<i class="evf-loading evf-loading-active" />'},init:function(){r=this.settings,l(document).ready(s.ready),0===l(".evf-connection-list-table tbody tr").length&&l(".toggle-switch").removeClass("connected"),l(".everest-forms-active-connections-list li").first().addClass("active-user"),l(".evf-provider-connections div").first().addClass("active-connection"),s.bindUIActions(),l(".evf-provider-conditional input").each(function(e,n){if(l(this).is(":checked")){s.getAllAvailableFields(l(this).closest(".evf-provider-conditional"));var t=l(this).parent("p").siblings(".evf-conditional-container");t.fadeIn("slow"),t.find(".evf-conditional-field-select").trigger("change")}})},ready:function(){r.formID=l("#everest-forms-builder-form").data("id")},bindUIActions:function(){l(document).on("click",".everest-forms-integration-connect-account",function(e){s.Connect(this,e)}),l(document).on("click",".everest-forms-integration-disconnect-account",function(e){s.disconnect(this,e)}),l(document).on("click",".everest-forms-connections-add",function(e){s.connectionAdd(this,e)}),l(document).on("click",".everest-forms-source-account-add button",function(e){s.accountAdd(this,e)}),l(document).on("change",".evf-provider-accounts select",function(e){s.accountSelect(this,e)}),l(document).on("change",".evf-provider-lists select",function(e){s.accountListSelect(this,e)}),l(document).on("click",".everest-forms-active-connections-list li a",function(e){s.selectActiveAccount(this,e)}),l(document).on("click",".toggle-remove",function(e){s.removeAccount(this,e)}),l(document).on("change",".evf-provider-conditional .evf-enable-conditional-logic",function(e){s.enableConditionLogic(this,e)}),l(document).on("change",".evf-conditional-field-select",function(e){s.inputType(this,e)})},Connect:function(e,n){n.preventDefault();var t=l(e),i=l(".evf-apikey").val(),o=l(".evf-nickname").val(),a=t.closest(".integration-connection-detail"),c={action:"everest_forms_integration_connect",apikey:i,label:o,source:t.data("source"),security:evfp_params.ajax_nonce};s.inputToggle(t,"disable"),l.ajax({url:evfp_params.ajax_url,data:c,type:"POST",success:function(e){if(!0===e.success)s.inputToggle(t,"enable"),l(".evf-connection-form :input").val(""),a.find(".evf-connection-list tbody").append(e.data.html),a.find(".integration-status").addClass("connected");else{s.inputToggle(t,"enable");var n=evfp_params.provider_auth_error;e.data.error_msg&&(n+="\n"+e.data.error_msg),l.alert({title:!1,content:n,icon:"dashicons dashicons-info",type:"orange",buttons:{confirm:{text:evfp_params.i18n_ok,btnClass:"btn-confirm",keys:["enter"]}}})}}})},disconnect:function(e,n){n.preventDefault();var t=l(e),i=(l(".evf-apikey").val(),l(".evf-nickname").val(),t.closest(".integration-connection-detail"),{action:"everest_forms_integration_disconnect",key:t.data("key"),source:t.data("source"),security:evfp_params.ajax_nonce});l.confirm({title:!1,content:"Are you sure you want to delete this connection?",backgroundDismiss:!1,closeIcon:!1,icon:"dashicons dashicons-info",type:"orange",buttons:{confirm:{text:evfp_params.i18n_ok,btnClass:"btn-confirm",keys:["enter"],action:function(){l.post(evfp_params.ajax_url,i,function(e){e.success?t.parent().parent().remove():console.log(e)}).fail(function(e){console.log(e.responseText)})}},cancel:{text:evfp_params.i18n_cancel,keys:["esc"]}}})},connectionAdd:function(e,n){n.preventDefault();var o=l(e),a=o.data("source"),c=o.closest(".everest-forms-panel-sidebar-content"),t=(o.parent(),o.data("type")),i=evfp_params.i18n_prompt_connection+('<input autofocus="" type="text" id="provider-connection-name" placeholder="'+evfp_params.i18n_prompt_placeholder+'">')+('<p class="error">'+evfp_params.i18n_error_name+"</p>");i=i.replace(/%type%/g,t),l.confirm({title:!1,content:i,icon:"dashicons dashicons-info",type:"blue",backgroundDismiss:!1,closeIcon:!1,buttons:{confirm:{text:evfp_params.i18n_ok,btnClass:"btn-confirm",keys:["enter"],action:function(){var e=this.$content.find("input#provider-connection-name"),n=this.$content.find(".error");if(""===e.val())return n.show(),!1;var t=e.val();s.inputToggle(o,"disable");var i={action:"everest_forms_new_connection_add_"+a,source:a,name:t,id:r.form.data("id"),security:evfp_params.ajax_nonce};l.ajax({url:evfp_params.ajax_url,data:i,type:"POST",success:function(e){s.inputToggle(o,"enable"),l(".everest-form-add-connection-notice").remove(),c.find(".evf-panel-content-section-"+a).find(".evf-provider-connections").append(e.data.html),c.find(".evf-provider-connection").removeClass("active-connection"),c.find(".evf-provider-connection").last().addClass("active-connection"),o.parent().find(".everest-forms-active-connections-list li").removeClass("active-user"),o.closest(".everest-forms-active-connections.active").children(".everest-forms-active-connections-list").removeClass("empty-list"),o.parent().find(".everest-forms-active-connections-list").append('<li class="active-user" data-connection-id= "'+e.data.connection_id+'"><a class="user-nickname" href="#">'+t+'</a><a href="#"><span class="toggle-remove">Remove</span></a></li>'),l(".everest-forms-panel-sidebar-section-"+a).siblings(".everest-forms-active-connections.active").children(".everest-forms-active-connections-list").children(".active-user").children(".user-nickname").trigger("click");var n=c.find(".evf-panel-content-section-"+a+" .evf-provider-connections .evf-provider-connection:last");n.find(".evf-provider-accounts option:selected")&&(n.find(".evf-provider-accounts option:first").prop("selected",!0),n.find(".evf-provider-accounts select").trigger("change"))}})}},cancel:{text:evfp_params.i18n_cancel}}})},accountAdd:function(e,n){n.preventDefault();var t=l(e),i=t.data("source"),o=t.closest(".evf-provider-connection"),a=t.parent(),c=a.find(":input"),r=s.requiredCheck(c,a);if(s.inputToggle(t,"disable"),r)return t.prop("disabled",!1).find("i").remove(),!1;data={action:"everest_forms_add_account_form_"+i,source:i,connection_id:o.data("connection_id"),data:s.fakeSerialize(c),security:evfp_params.ajax_nonce},l.ajax({url:evfp_params.ajax_url,data:data,type:"POST",success:function(e){!0===e.success?(a.nextAll(".evf-connection-block").remove(),a.nextAll(".evf-conditional-block").remove(),a.after(e.data.html),a.slideUp(),o.find(".evf-provider-accounts select").trigger("change")):(s.inputToggle(t,"enable"),s.errorDisplay(e.data.error,a))}})},accountSelect:function(e,n){n.preventDefault();var t=l(e),i=t.closest(".evf-provider-connection"),o=t.parent(),a=i.data("provider");s.inputToggle(t,"disable"),o.nextAll(".evf-connection-block").remove(),o.nextAll(".evf-conditional-block").remove(),t.val()?(i.find(".everest-forms-source-account-add").slideUp(),data={action:"everest_forms_account_select_"+a,source:a,connection_id:i.data("connection_id"),account_id:t.find(":selected").val(),security:evfp_params.ajax_nonce},l.ajax({url:evfp_params.ajax_url,data:data,type:"POST",success:function(e){e.success?(s.inputToggle(t,"enable"),o.after(e.data.html),i.find(".evf-provider-lists option:first").prop("selected",!0),i.find(".evf-provider-lists select").trigger("change")):(s.inputToggle(t,"enable"),l(".evf-alert-danger").remove(),l(".evf-provider-connection.active-connection").append('<p class="evf-alert-danger evf-alert everest-forms-error-msg">'+e.data.error+"</p>"))}})):(i.find(".everest-forms-source-account-add input").val(""),l(".everest-form-add-connection-notice").remove(),i.find(".everest-forms-source-account-add").slideDown(),s.inputToggle(t,"enable"))},accountListSelect:function(e,n){n.preventDefault();var t=l(e),i=t.closest(".evf-provider-connection"),o=t.parent(),a=i.data("provider");s.inputToggle(t,"disable"),o.nextAll(".evf-connection-block").remove(),o.nextAll(".evf-conditional-block").remove(),data={action:"everest_forms_account_list_select_"+a,source:a,connection_id:i.data("connection_id"),account_id:i.find(".evf-provider-accounts option:selected").val(),list_id:t.find(":selected").val(),security:evfp_params.ajax_nonce,form_id:r.formID},l.ajax({url:evfp_params.ajax_url,data:data,type:"POST",success:function(e){s.inputToggle(t,"enable"),o.after(e.data.html)}})},selectActiveAccount:function(e,n){n.preventDefault();var t=l(e),i=t.parent().data("connection-id"),o=l(".evf-provider-connections").find('[data-connection_id="'+i+'"]'),a=l(o).length;l(".evf-provider-connections").find(".evf-provider-connection").removeClass("active-connection"),t.parent().siblings().removeClass("active-user"),t.parent().addClass("active-user"),a&&l(o).addClass("active-connection")},removeAccount:function(e,n){n.preventDefault();var t=l(e),i=t.parent().parent().data("connection-id"),o=l(".evf-provider-connections").find('[data-connection_id="'+i+'"]'),a=l(o).length,c=t.closest(".everest-forms-active-connections-list");l.confirm({title:!1,content:"Are you sure you want to delete this connection?",backgroundDismiss:!1,closeIcon:!1,icon:"dashicons dashicons-info",type:"orange",buttons:{confirm:{text:evfp_params.i18n_ok,btnClass:"btn-confirm",keys:["enter"],action:function(){if(a){var e=t.parent().parent();active_block_after=l(".evf-provider-connections").find('[data-connection_id="'+i+'"]'),lengthOfActiveBlockAfter=l(o).length,e.prev().length?e.prev().children(".user-nickname").trigger("click"):e.next().children(".user-nickname").trigger("click"),l(o).remove(),e.remove(),0===l(".everest-forms-active-connections.active").children(".everest-forms-active-connections-list").children().length&&(c.addClass("empty-list"),l(".evf-provider-connections").append('<div class="everest-form-add-connection-notice">Please add a connection.</div>'))}}},cancel:{text:evfp_params.i18n_cancel}}})},enableConditionLogic:function(e,n){var t=l(e);t.is(":checked")?(s.getAllAvailableFields(t.closest(".evf-provider-conditional")),t.parent().siblings(".evf-conditional-container").fadeIn("slow"),t.parent().siblings(".evf-conditional-container").find(".evf-conditional-field-select").trigger("change")):t.parent().siblings(".evf-conditional-container").fadeOut("slow")},inputType:function(e,n){n.preventDefault();var o=l(e),t=o.find(":selected").data("field_id"),i=o.parent().parent().data("con_id"),a=o.parent().parent().data("source"),c=l(".everest-forms-panel-sidebar .everest-forms-tab-content").find('.everest-forms-field-option[data-field-id="'+t+'"]').first(),r=c.find(".everest-forms-field-option-group-inner .everest-forms-field-option-row-choices ul").find("input.label"),s="undefined"!=typeof evf_integration_data&&"undefined"!=typeof evf_integration_data[a]&&"undefined"!=typeof evf_integration_data[a][i]?evf_integration_data[a][i].conditional_logic:"";switch("zapier"===a&&(i="zapier_connection"),o.find(":selected").data("field_type")){default:o.parent().find(".evf-conditional-input").remove();var d=s&&"undefined"!=typeof s.input_choice?s.input_choice:"";o.parent().append('<input class="evf-conditional-input" type="text" name="integrations['+a+"]["+i+'][conditional_logic][input_choice]" value="'+d+'"></input>');break;case"checkbox":case"radio":case"select":o.parent().find(".evf-conditional-input").remove(),o.parent().append('<select class="evf-conditional-input" name="integrations['+a+"]["+i+'][conditional_logic][multiple_choice]"></select>'),l(r).each(function(e,n){var t=l(n).val(),i="";s&&t===s.multiple_choice&&(i="selected"),o.parent().find(".evf-conditional-input").append('<option value="'+t+'" '+i+">"+t+"</option>")});break;case"country":o.parent().find(".evf-conditional-input").remove(),o.parent().append('<select class="evf-conditional-input" name="integrations['+a+"]["+i+'][conditional_logic][country_choice]"></select>'),r=c.find(".everest-forms-field-option-group-advanced .everest-forms-field-option-row-default select").children(),l(r).each(function(e,n){var t=l(n).val(),i="";s&&t===s.country_choice&&(i="selected"),o.parent().find(".evf-conditional-input").append('<option value="'+t+'" '+i+">"+l(n).text()+"</option>")})}},getAllAvailableFields:function(c){var r=l(c).children(".evf-conditional-container").data("con_id"),s=l(c).children(".evf-conditional-container").data("source");l(c).parent().find(".evf-conditional-container .evf-conditional-wrapper .evf-conditional-field-select").empty(),l(".evf-admin-row .evf-admin-grid .everest-forms-field").each(function(){var e,n=l(this).data("field-type"),t="undefined"!=typeof evf_integration_data&&"undefined"!=typeof evf_integration_data[s]&&"undefined"!=typeof evf_integration_data[s][r]?evf_integration_data[s][r].conditional_logic:"",i=l(this).data("field-id"),o=l(this).find(".label-title span").first().text(),a="";e=["html","title","address","image-upload","file-upload","date-time","payment-multiple","payment-single","payment-checkbox","payment-total"],t&&i===t.field_select&&(a="selected"),-1===l.inArray(n,e)&&l(c).parent().find(".evf-conditional-container .evf-conditional-wrapper .evf-conditional-field-select").append('<option class="evf-conditional-fields" data-field_type="'+n+'" data-field_id="'+i+'" value="'+i+'" '+a+">"+o+"</option>")})},inputToggle:function(e,n){var t=l(e);"enable"==n?t.is("select")?t.prop("disabled",!1).next("i").remove():t.prop("disabled",!1).find("i").remove():"disable"==n&&(t.is("select")?t.prop("disabled",!0).after(r.spinner):t.prop("disabled",!0).prepend(r.spinner))},errorDisplay:function(e,n){n.find(".everest-forms-error-msg").remove(),n.prepend('<p class="evf-alert-danger evf-alert everest-forms-error-msg">'+e+"</p>")},requiredCheck:function(e,n){var t=!1;return n.find(".evf-alert-required").remove(),e.each(function(e,n){l(n).hasClass("everest-forms-required")&&0===l(n).val().length?(l(n).addClass("everest-forms-error"),t=!0):l(n).removeClass("everest-forms-error")}),t&&(n.find(".everest-forms-error-msg").remove(),n.prepend('<p class="evf-alert-danger evf-alert evf-alert-required">'+evfp_params.required_field+"</p>")),t},fakeSerialize:function(e){var n=e.clone();return n.each(function(e,n){l(n).data("name")&&l(n).attr("name",l(n).data("name"))}),n.serialize()}};s.init()}(jQuery);